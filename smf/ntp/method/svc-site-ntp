#!/usr/bin/ksh

# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.

# Copyright 2023 Oxide Computer Company

. /lib/svc/share/smf_include.sh

function die {
	typeset rc=$1; shift
	echo "$@" >&2
	exit $rc
}

function fatal { die $SMF_EXIT_ERR_FATAL "$@"; }
function config { die $SMF_EXIT_ERR_CONFIG "$@"; }

[[ -n "$SMF_FMRI" ]] || fatal "SMF framework variables are not initialized."

typeset -r action=${1:?action parameter not specified}
typeset -r contract=$2	# For the refresh and stop methods

for var in file boundary server allow; do
	nameref _var=$var

LISTEN_ADDR="$(svcprop -c -p config/listen_addr "${SMF_FMRI}")"
ALL_LINKS=$(svcprop -c -p config/all_links "${SMF_FMRI}")
DATALINK="$(svcprop -c -p config/datalink "${SMF_FMRI}")"
GATEWAY="$(svcprop -c -p config/gateway "${SMF_FMRI}")"

if [[ "$ALL_LINKS" == unknown ]] || \
  [[ "$LISTEN_ADDR" == unknown ]] || \
  [[ "$DATALINK" == unknown ]] || \
  [[ "$GATEWAY" == unknown ]]; then
    printf 'ERROR: missing all_links, listen_addr, datalink or gateway\n' >&2
    exit "$SMF_EXIT_ERR_CONFIG"
fi

ALL_LINKS=( $ALL_LINKS )

for LINK in "${ALL_LINKS[@]}"; do
    ipadm show-addr "$LINK/ll" || ipadm create-addr -t -T addrconf "$LINK/ll"
done
ipadm show-addr "$DATALINK/ll" || ipadm create-addr -t -T addrconf "$DATALINK/ll"
ipadm show-addr "$DATALINK/omicron6"  || ipadm create-addr -t -T static -a "$LISTEN_ADDR" "$DATALINK/omicron6"
route get -inet6 default -inet6 "$GATEWAY" || route add -inet6 default -inet6 "$GATEWAY"

	typeset _var=`svcprop -p config/$var $SMF_FMRI`
	(($? == 0)) || config "Could not retrieve config/$var property"
	[[ $_var == '""' ]] && _var=

	# config/allow is optional - not used for non-boundary configurations.
	if [[ $var != allow ]]; then
		[[ -n "$_var" ]] || config "config/$var is empty."
	fi
done

typeset template=/etc/inet/chrony.conf.internal
[[ "$boundary" = true ]] && template=/etc/inet/chrony.conf.boundary

cat <<-EOM
	NTP Service Configuration
	-------------------------
	 Servers: $server
	   Allow: $allow
	Boundary: $boundary
	Template: $template
	  Config: $file
EOM

function generate_config_file {
	typeset oldsum=
	[[ -r "$file" ]] && oldsum=$(digest -a sha256 $file)

	serverline=$(grep '@SERVER@' $template | head -1)
	[[ -n "$serverline" ]] || fatal "No @SERVER@ line found in $template"

	{
		sed < $template "
			/@SERVER@/d
			s^@ALLOW@^$allow^g
		" || fatal "Could not generate configuration file"
		for s in $server; do
			echo "$serverline" | sed "s^@SERVER@^$s^"
		done
		echo
	} > $file

	typeset newsum=$(digest -a sha256 $file)

	# This function's exit status indicates if the configuration file has
	# changed.
	[[ -z "$oldsum" || "$oldsum" != "$newsum" ]]
}

function start_daemon {
	echo "* Starting daemon"
	/usr/sbin/chronyd -f "$file"
}

function stop_daemon {
	echo "* Stopping daemon"
	smf_kill_contract $contract TERM 1 30
	rc=$?
	((rc == 1)) && fatal "Invalid contract in $action"
	# It's possible that the contract did not empty with SIGTERM; move on
	# to KILL.
	((rc == 2)) && smf_kill_contract $contract KILL 1
}

case $action in
	start)
		generate_config_file
		start_daemon
		;;
	refresh)
		generate_config_file && stop_daemon
		# SMF will restart the service since the contract is now empty.
		;;
	stop)
		stop_daemon
		;;
	*)
		fatal "Unknown action '$action'"
		;;
esac

exit $SMF_EXIT_OK

